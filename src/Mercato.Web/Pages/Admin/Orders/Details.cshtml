@page "{id:guid}"
@model Mercato.Web.Pages.Admin.Orders.DetailsModel
@using Mercato.Orders.Domain.Entities
@{
    ViewData["Title"] = Model.Order != null ? $"Order {Model.Order.OrderNumber}" : "Order Details";
}

<div class="container-fluid py-4">
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a asp-page="/Admin/Index">Admin</a></li>
            <li class="breadcrumb-item"><a asp-page="Index">Orders</a></li>
            <li class="breadcrumb-item active" aria-current="page">@(Model.Order?.OrderNumber ?? "Order Details")</li>
        </ol>
    </nav>

    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert-danger">@Model.ErrorMessage</div>
    }
    else if (Model.Order != null)
    {
        var order = Model.Order;
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="mb-1">@order.OrderNumber</h1>
                <p class="text-muted mb-0">
                    Placed on @order.CreatedAt.ToString("MMMM dd, yyyy 'at' h:mm tt")
                </p>
            </div>
            <span class="badge fs-5 @DetailsModel.GetStatusBadgeClass(order.Status)">
                @DetailsModel.GetStatusDisplayText(order.Status)
            </span>
        </div>

        <div class="row">
            @* Left Column - Order Details *@
            <div class="col-lg-8">
                @* Order Summary Card *@
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-receipt me-2"></i>Order Summary</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <dl>
                                    <dt>Order ID</dt>
                                    <dd><code>@order.Id</code></dd>
                                    <dt>Buyer ID</dt>
                                    <dd><code>@order.BuyerId</code></dd>
                                    <dt>Buyer Email</dt>
                                    <dd>@(order.BuyerEmail ?? "N/A")</dd>
                                    <dt>Payment Method</dt>
                                    <dd>@(order.PaymentMethodName ?? "N/A")</dd>
                                </dl>
                            </div>
                            <div class="col-md-6">
                                <dl>
                                    <dt>Items Subtotal</dt>
                                    <dd>@order.ItemsSubtotal.ToString("C")</dd>
                                    <dt>Shipping</dt>
                                    <dd>@order.ShippingTotal.ToString("C")</dd>
                                    <dt>Total Amount</dt>
                                    <dd><strong class="text-primary fs-5">@order.TotalAmount.ToString("C")</strong></dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>

                @* Seller Sub-Orders with Status History *@
                @foreach (var subOrder in order.SellerSubOrders.OrderBy(s => s.StoreName))
                {
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-0">
                                    <i class="bi bi-shop me-2"></i>@subOrder.StoreName
                                </h5>
                                <small class="text-muted">Sub-order: @subOrder.SubOrderNumber</small>
                            </div>
                            <span class="badge @DetailsModel.GetSubOrderStatusBadgeClass(subOrder.Status)">
                                @DetailsModel.GetSubOrderStatusDisplayText(subOrder.Status)
                            </span>
                        </div>
                        <div class="card-body p-0">
                            @* Items Table *@
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Product</th>
                                            <th class="text-center">Qty</th>
                                            <th class="text-center">Status</th>
                                            <th class="text-end">Price</th>
                                            <th class="text-end">Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var item in subOrder.Items)
                                        {
                                            <tr class="@(item.Status == SellerSubOrderItemStatus.Cancelled ? "table-danger" : "")">
                                                <td>@item.ProductTitle</td>
                                                <td class="text-center">@item.Quantity</td>
                                                <td class="text-center">
                                                    <span class="badge @DetailsModel.GetItemStatusBadgeClass(item.Status)">
                                                        @DetailsModel.GetItemStatusDisplayText(item.Status)
                                                    </span>
                                                </td>
                                                <td class="text-end">@item.UnitPrice.ToString("C")</td>
                                                <td class="text-end">@item.TotalPrice.ToString("C")</td>
                                            </tr>
                                        }
                                    </tbody>
                                    <tfoot class="table-light">
                                        <tr>
                                            <td colspan="4" class="text-end"><strong>Sub-order Total:</strong></td>
                                            <td class="text-end"><strong>@subOrder.TotalAmount.ToString("C")</strong></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>

                            @* Shipping Info *@
                            @if (subOrder.ShippedAt.HasValue || !string.IsNullOrEmpty(subOrder.TrackingNumber))
                            {
                                <div class="p-3 border-top bg-light">
                                    <i class="bi bi-truck me-2"></i>
                                    <strong>Shipping Info:</strong>
                                    @if (!string.IsNullOrEmpty(subOrder.ShippingCarrier))
                                    {
                                        <span class="ms-2">@subOrder.ShippingCarrier</span>
                                    }
                                    @if (!string.IsNullOrEmpty(subOrder.TrackingNumber))
                                    {
                                        <span class="ms-2 font-monospace">@subOrder.TrackingNumber</span>
                                    }
                                    @if (subOrder.ShippedAt.HasValue)
                                    {
                                        <span class="text-muted ms-2">
                                            (Shipped @subOrder.ShippedAt.Value.ToString("MMM dd, yyyy"))
                                        </span>
                                    }
                                </div>
                            }

                            @* Shipping Status History - Key Feature for Admin *@
                            @if (Model.SubOrderStatusHistories.TryGetValue(subOrder.Id, out var history) && history.Count > 0)
                            {
                                <div class="p-3 border-top">
                                    <h6 class="mb-3">
                                        <i class="bi bi-clock-history me-2"></i>Shipping Status History
                                    </h6>
                                    <div class="timeline">
                                        @foreach (var entry in history.OrderByDescending(h => h.ChangedAt))
                                        {
                                            <div class="d-flex mb-2">
                                                <div class="flex-shrink-0">
                                                    <span class="badge rounded-circle p-2 @DetailsModel.GetSubOrderStatusBadgeClass(entry.NewStatus)">
                                                        <i class="bi bi-check"></i>
                                                    </span>
                                                </div>
                                                <div class="flex-grow-1 ms-3">
                                                    <div class="d-flex justify-content-between">
                                                        <div>
                                                            <strong>@DetailsModel.GetSubOrderStatusDisplayText(entry.NewStatus)</strong>
                                                            @if (entry.PreviousStatus.HasValue)
                                                            {
                                                                <span class="text-muted">
                                                                    (from @DetailsModel.GetSubOrderStatusDisplayText(entry.PreviousStatus.Value))
                                                                </span>
                                                            }
                                                        </div>
                                                        <small class="text-muted">
                                                            @entry.ChangedAt.ToString("MMM dd, yyyy h:mm tt")
                                                        </small>
                                                    </div>
                                                    @if (!string.IsNullOrEmpty(entry.TrackingNumber) || !string.IsNullOrEmpty(entry.ShippingCarrier))
                                                    {
                                                        <small class="text-muted">
                                                            @if (!string.IsNullOrEmpty(entry.ShippingCarrier))
                                                            {
                                                                <span>Carrier: @entry.ShippingCarrier</span>
                                                            }
                                                            @if (!string.IsNullOrEmpty(entry.TrackingNumber))
                                                            {
                                                                <span class="ms-2">Tracking: @entry.TrackingNumber</span>
                                                            }
                                                        </small>
                                                    }
                                                    @if (!string.IsNullOrEmpty(entry.Notes))
                                                    {
                                                        <small class="text-muted d-block">Note: @entry.Notes</small>
                                                    }
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                            else
                            {
                                <div class="p-3 border-top">
                                    <small class="text-muted">
                                        <i class="bi bi-info-circle me-1"></i>No shipping status history available for this sub-order.
                                    </small>
                                </div>
                            }
                        </div>
                    </div>
                }

                @* Order Timeline *@
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Order Timeline</h5>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled mb-0">
                            <li class="d-flex align-items-start mb-3">
                                <span class="badge bg-success rounded-circle p-2 me-3"><i class="bi bi-check"></i></span>
                                <div>
                                    <strong>Order Created</strong>
                                    <br><small class="text-muted">@order.CreatedAt.ToString("MMMM dd, yyyy 'at' h:mm tt")</small>
                                </div>
                            </li>
                            @if (order.ConfirmedAt.HasValue)
                            {
                                <li class="d-flex align-items-start mb-3">
                                    <span class="badge bg-success rounded-circle p-2 me-3"><i class="bi bi-check"></i></span>
                                    <div>
                                        <strong>Payment Confirmed</strong>
                                        <br><small class="text-muted">@order.ConfirmedAt.Value.ToString("MMMM dd, yyyy 'at' h:mm tt")</small>
                                    </div>
                                </li>
                            }
                            @if (order.ShippedAt.HasValue)
                            {
                                <li class="d-flex align-items-start mb-3">
                                    <span class="badge bg-success rounded-circle p-2 me-3"><i class="bi bi-check"></i></span>
                                    <div>
                                        <strong>Shipped</strong>
                                        <br><small class="text-muted">@order.ShippedAt.Value.ToString("MMMM dd, yyyy 'at' h:mm tt")</small>
                                    </div>
                                </li>
                            }
                            @if (order.DeliveredAt.HasValue)
                            {
                                <li class="d-flex align-items-start mb-3">
                                    <span class="badge bg-success rounded-circle p-2 me-3"><i class="bi bi-check"></i></span>
                                    <div>
                                        <strong>Delivered</strong>
                                        <br><small class="text-muted">@order.DeliveredAt.Value.ToString("MMMM dd, yyyy 'at' h:mm tt")</small>
                                    </div>
                                </li>
                            }
                            @if (order.CancelledAt.HasValue)
                            {
                                <li class="d-flex align-items-start mb-3">
                                    <span class="badge bg-danger rounded-circle p-2 me-3"><i class="bi bi-x"></i></span>
                                    <div>
                                        <strong>Cancelled</strong>
                                        <br><small class="text-muted">@order.CancelledAt.Value.ToString("MMMM dd, yyyy 'at' h:mm tt")</small>
                                    </div>
                                </li>
                            }
                            @if (order.RefundedAt.HasValue)
                            {
                                <li class="d-flex align-items-start mb-3">
                                    <span class="badge bg-dark rounded-circle p-2 me-3"><i class="bi bi-arrow-counterclockwise"></i></span>
                                    <div>
                                        <strong>Refunded</strong>
                                        <br><small class="text-muted">@order.RefundedAt.Value.ToString("MMMM dd, yyyy 'at' h:mm tt")</small>
                                    </div>
                                </li>
                            }
                        </ul>
                    </div>
                </div>
            </div>

            @* Right Column - Buyer & Delivery Info *@
            <div class="col-lg-4">
                @* Delivery Address *@
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-geo-alt me-2"></i>Delivery Address</h5>
                    </div>
                    <div class="card-body">
                        <strong>@order.DeliveryFullName</strong><br>
                        @order.DeliveryAddressLine1<br>
                        @if (!string.IsNullOrEmpty(order.DeliveryAddressLine2))
                        {
                            @order.DeliveryAddressLine2<br>
                        }
                        @order.DeliveryCity@(string.IsNullOrEmpty(order.DeliveryState) ? "" : ", " + order.DeliveryState) @order.DeliveryPostalCode<br>
                        @order.DeliveryCountry
                        @if (!string.IsNullOrEmpty(order.DeliveryPhoneNumber))
                        {
                            <br><span class="text-muted small"><i class="bi bi-telephone me-1"></i>@order.DeliveryPhoneNumber</span>
                        }
                    </div>
                </div>

                @* Delivery Instructions *@
                @if (!string.IsNullOrEmpty(order.DeliveryInstructions))
                {
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Delivery Instructions</h5>
                        </div>
                        <div class="card-body">
                            <p class="mb-0">@order.DeliveryInstructions</p>
                        </div>
                    </div>
                }

                @* Technical Details *@
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-code me-2"></i>Technical Details</h5>
                    </div>
                    <div class="card-body">
                        <dl class="mb-0">
                            <dt>Order ID</dt>
                            <dd><code class="small">@order.Id</code></dd>
                            <dt>Payment Transaction ID</dt>
                            <dd><code class="small">@(order.PaymentTransactionId?.ToString() ?? "N/A")</code></dd>
                            <dt>Last Updated</dt>
                            <dd>@order.LastUpdatedAt.ToString("MMM dd, yyyy h:mm tt")</dd>
                        </dl>
                    </div>
                </div>

                @* Actions *@
                <div class="d-grid gap-2">
                    <a asp-page="Index" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left me-1"></i>Back to Orders
                    </a>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="alert alert-warning">
            <h5>Order Not Found</h5>
            <p>We couldn't find the order you're looking for.</p>
            <a asp-page="Index" class="btn btn-primary">Back to Orders</a>
        </div>
    }
</div>
