@page
@model Mercato.Web.Pages.Admin.Refunds.CreateModel
@{
    ViewData["Title"] = "Process Refund";
}

<h1>Process Refund</h1>

<div class="alert alert-info">
    <strong>Order ID:</strong> <code>@Model.OrderId</code>
</div>

@if (!string.IsNullOrEmpty(Model.ErrorMessage))
{
    <div class="alert alert-danger">
        <strong>Error:</strong> @Model.ErrorMessage
    </div>
}

@if (!string.IsNullOrEmpty(Model.SuccessMessage))
{
    <div class="alert alert-success">
        @Model.SuccessMessage
    </div>
}

<div class="row">
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">Escrow Status</h5>
            </div>
            <div class="card-body">
                @if (Model.EscrowEntries.Count == 0)
                {
                    <div class="alert alert-warning mb-0">
                        No escrow entries found for this order.
                    </div>
                }
                else
                {
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Seller ID</th>
                                <th>Status</th>
                                <th class="text-end">Original Amount</th>
                                <th class="text-end">Refunded</th>
                                <th class="text-end">Available</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var entry in Model.EscrowEntries)
                            {
                                var remaining = entry.Amount - entry.RefundedAmount;
                                <tr>
                                    <td><code>@entry.SellerId.ToString()[..8]...</code></td>
                                    <td>
                                        @switch (entry.Status)
                                        {
                                            case Mercato.Payments.Domain.Entities.EscrowStatus.Held:
                                                <span class="badge bg-primary">Held</span>
                                                break;
                                            case Mercato.Payments.Domain.Entities.EscrowStatus.PartiallyRefunded:
                                                <span class="badge bg-warning text-dark">Partially Refunded</span>
                                                break;
                                            case Mercato.Payments.Domain.Entities.EscrowStatus.Refunded:
                                                <span class="badge bg-danger">Refunded</span>
                                                break;
                                            case Mercato.Payments.Domain.Entities.EscrowStatus.Released:
                                                <span class="badge bg-success">Released</span>
                                                break;
                                        }
                                    </td>
                                    <td class="text-end">@entry.Amount.ToString("C")</td>
                                    <td class="text-end text-danger">@entry.RefundedAmount.ToString("C")</td>
                                    <td class="text-end">
                                        @if (remaining > 0)
                                        {
                                            <strong class="text-success">@remaining.ToString("C")</strong>
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                        <tfoot>
                            <tr class="table-light">
                                <td colspan="4" class="text-end"><strong>Total Available for Refund:</strong></td>
                                <td class="text-end"><strong class="text-success">@Model.TotalAvailableForRefund.ToString("C")</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                }
            </div>
        </div>

        @if (Model.TotalAvailableForRefund > 0)
        {
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Refund Details</h5>
                </div>
                <div class="card-body">
                    <form method="post">
                        <input type="hidden" asp-for="OrderId" />
                        <input type="hidden" asp-for="PaymentTransactionId" />

                        <div class="mb-3">
                            <label class="form-label">Refund Type</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" asp-for="IsFullRefund" value="true" id="fullRefund" />
                                <label class="form-check-label" for="fullRefund">
                                    Full Refund (@Model.TotalAvailableForRefund.ToString("C"))
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" asp-for="IsFullRefund" value="false" id="partialRefund" checked />
                                <label class="form-check-label" for="partialRefund">
                                    Partial Refund
                                </label>
                            </div>
                        </div>

                        <div id="partialRefundFields">
                            <div class="mb-3">
                                <label asp-for="SellerId" class="form-label">Seller (Optional)</label>
                                <select asp-for="SellerId" class="form-select">
                                    <option value="">-- Select a seller (or leave empty for auto-select) --</option>
                                    @foreach (var entry in Model.EscrowEntries.Where(e => e.Status == Mercato.Payments.Domain.Entities.EscrowStatus.Held || e.Status == Mercato.Payments.Domain.Entities.EscrowStatus.PartiallyRefunded))
                                    {
                                        var remaining = entry.Amount - entry.RefundedAmount;
                                        <option value="@entry.SellerId">@entry.SellerId.ToString()[..8]... - Available: @remaining.ToString("C")</option>
                                    }
                                </select>
                            </div>

                            <div class="mb-3">
                                <label asp-for="Amount" class="form-label">Refund Amount</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input asp-for="Amount" class="form-control" type="number" step="0.01" min="0.01" max="@Model.TotalAvailableForRefund" />
                                </div>
                                <div class="form-text">Maximum: @Model.TotalAvailableForRefund.ToString("C")</div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Reason" class="form-label">Reason <span class="text-danger">*</span></label>
                            <textarea asp-for="Reason" class="form-control" rows="3" required></textarea>
                        </div>

                        <div class="mb-3">
                            <label asp-for="AuditNote" class="form-label">Audit Note (Optional)</label>
                            <textarea asp-for="AuditNote" class="form-control" rows="2"></textarea>
                        </div>

                        <div class="d-flex justify-content-between">
                            <a asp-page="/Admin/Index" class="btn btn-outline-secondary">
                                &laquo; Cancel
                            </a>
                            <button type="submit" class="btn btn-danger">
                                <i class="bi bi-arrow-counterclockwise"></i> Process Refund
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const fullRefundRadio = document.getElementById('fullRefund');
            const partialRefundRadio = document.getElementById('partialRefund');
            const partialRefundFields = document.getElementById('partialRefundFields');

            function togglePartialFields() {
                if (fullRefundRadio.checked) {
                    partialRefundFields.style.display = 'none';
                } else {
                    partialRefundFields.style.display = 'block';
                }
            }

            fullRefundRadio.addEventListener('change', togglePartialFields);
            partialRefundRadio.addEventListener('change', togglePartialFields);
            togglePartialFields();
        });
    </script>
}
