@page
@model Mercato.Web.Pages.Admin.DataProcessing.IndexModel
@{
    ViewData["Title"] = "Data Processing Registry";
    
    string Truncate(string text, int maxLength)
    {
        if (string.IsNullOrEmpty(text) || text.Length <= maxLength)
            return text ?? string.Empty;
        return $"{text[..maxLength]}...";
    }
}

<h1>Data Processing Registry</h1>

<div class="alert alert-info">
    <strong>GDPR Compliance</strong> - Manage the registry of personal data processing activities as required by GDPR Article 30.
</div>

@if (!string.IsNullOrEmpty(Model.SuccessMessage))
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @Model.SuccessMessage
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@if (!string.IsNullOrEmpty(Model.ErrorMessage))
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @Model.ErrorMessage
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<div class="mb-3 d-flex justify-content-between align-items-center">
    <div>
        <a asp-page="Create" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> Add Processing Activity
        </a>
    </div>
    <div>
        <form method="post" asp-page-handler="Export" class="d-inline">
            <button type="submit" class="btn btn-outline-success">
                <i class="bi bi-download"></i> Export to CSV
            </button>
        </form>
    </div>
</div>

<div class="mb-3">
    <div class="btn-group" role="group" aria-label="Filter activities">
        <a asp-page="Index" asp-route-showInactive="false" 
           class="btn @(Model.ShowInactive ? "btn-outline-secondary" : "btn-secondary")">
            Active Only
        </a>
        <a asp-page="Index" asp-route-showInactive="true" 
           class="btn @(Model.ShowInactive ? "btn-secondary" : "btn-outline-secondary")">
            Show All
        </a>
    </div>
</div>

@if (Model.Activities.Count == 0)
{
    <div class="alert alert-warning">
        <strong>No processing activities found.</strong> Click "Add Processing Activity" to create your first entry.
    </div>
}
else
{
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>Name</th>
                    <th>Purpose</th>
                    <th>Legal Basis</th>
                    <th>Data Subjects</th>
                    <th>Retention</th>
                    <th>Status</th>
                    <th>Last Updated</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var activity in Model.Activities)
                {
                    <tr class="@(activity.IsActive ? "" : "table-secondary")">
                        <td>
                            <a asp-page="Details" asp-route-id="@activity.Id">
                                @activity.Name
                            </a>
                        </td>
                        <td>
                            <span title="@activity.Purpose">
                                @Truncate(activity.Purpose, 50)
                            </span>
                        </td>
                        <td>@activity.LegalBasis</td>
                        <td>
                            <span title="@activity.DataSubjectCategories">
                                @Truncate(activity.DataSubjectCategories, 30)
                            </span>
                        </td>
                        <td>@activity.RetentionPeriod</td>
                        <td>
                            @if (activity.IsActive)
                            {
                                <span class="badge bg-success">Active</span>
                            }
                            else
                            {
                                <span class="badge bg-secondary">Inactive</span>
                            }
                        </td>
                        <td>
                            @if (activity.UpdatedAt.HasValue)
                            {
                                @activity.UpdatedAt.Value.ToString("yyyy-MM-dd HH:mm")
                            }
                            else
                            {
                                @activity.CreatedAt.ToString("yyyy-MM-dd HH:mm")
                            }
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                <a asp-page="Details" asp-route-id="@activity.Id" class="btn btn-outline-info" title="View Details">
                                    <i class="bi bi-eye"></i>
                                </a>
                                @if (activity.IsActive)
                                {
                                    <a asp-page="Edit" asp-route-id="@activity.Id" class="btn btn-outline-primary" title="Edit">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                }
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

<div class="card mt-4">
    <div class="card-header">
        <h6 class="mb-0">About the Data Processing Registry</h6>
    </div>
    <div class="card-body">
        <p class="small text-muted mb-2">
            This registry maintains records of processing activities as required by GDPR Article 30:
        </p>
        <ul class="small text-muted mb-0">
            <li><strong>Purpose</strong> - The specific purpose(s) for processing personal data.</li>
            <li><strong>Legal Basis</strong> - The lawful basis for processing (Consent, Contract, Legal Obligation, etc.).</li>
            <li><strong>Data Categories</strong> - Types of personal data being processed.</li>
            <li><strong>Data Subjects</strong> - Categories of individuals whose data is processed.</li>
            <li><strong>Recipients</strong> - Third parties with whom data is shared.</li>
            <li><strong>Retention</strong> - How long data is retained before deletion.</li>
            <li><strong>Security Measures</strong> - Technical and organizational measures protecting the data.</li>
        </ul>
        <p class="small text-muted mt-2 mb-0">
            All changes are versioned and timestamped for audit purposes. Use the Export function to generate compliance reports.
        </p>
    </div>
</div>

<div class="mt-4">
    <a asp-page="/Admin/Index" class="btn btn-outline-secondary">
        &laquo; Back to Admin Dashboard
    </a>
</div>
