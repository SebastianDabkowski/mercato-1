@page
@model Mercato.Web.Pages.Orders.ShippingModel
@{
    ViewData["Title"] = "Checkout - Shipping";
}

<div class="container py-4">
    <h1 class="mb-4">Checkout</h1>

    <!-- Progress Steps -->
    <div class="mb-4">
        <div class="d-flex justify-content-between">
            <div class="text-center">
                <span class="badge bg-success rounded-pill p-2"><i class="bi bi-check"></i></span>
                <div class="small mt-1 text-success">Address</div>
            </div>
            <div class="text-center">
                <span class="badge bg-primary rounded-pill p-2">2</span>
                <div class="small mt-1 fw-bold">Shipping</div>
            </div>
            <div class="text-center">
                <span class="badge bg-secondary rounded-pill p-2">3</span>
                <div class="small mt-1 text-muted">Payment</div>
            </div>
            <div class="text-center">
                <span class="badge bg-secondary rounded-pill p-2">4</span>
                <div class="small mt-1 text-muted">Confirmation</div>
            </div>
        </div>
    </div>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["Success"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert-danger">@Model.ErrorMessage</div>
    }

    <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

    @if (Model.IsCartEmpty)
    {
        <div class="alert alert-warning">
            Your cart is empty. <a asp-page="/Product/Index">Continue shopping</a>.
        </div>
    }
    else
    {
        <div class="row">
            <!-- Shipping Method Selection -->
            <div class="col-lg-8">
                <form method="post">
                    <!-- Delivery Address Summary -->
                    @if (Model.DeliveryAddress != null)
                    {
                        <div class="card mb-4">
                            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="bi bi-geo-alt me-2"></i>Delivery Address
                                </h5>
                                <a asp-page="Checkout" class="btn btn-sm btn-outline-secondary">Change</a>
                            </div>
                            <div class="card-body">
                                <strong>@Model.DeliveryAddress.FullName</strong><br>
                                @Model.DeliveryAddress.FormattedAddress
                                @if (!string.IsNullOrEmpty(Model.DeliveryAddress.PhoneNumber))
                                {
                                    <br><span class="text-muted small"><i class="bi bi-telephone me-1"></i>@Model.DeliveryAddress.PhoneNumber</span>
                                }
                            </div>
                        </div>
                    }

                    <!-- Shipping Methods by Store -->
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">
                                <i class="bi bi-truck me-2"></i>Select Shipping Methods
                            </h5>
                        </div>
                        <div class="card-body">
                            @foreach (var storeGroup in Model.CartResult.ItemsByStore)
                            {
                                <div class="mb-4">
                                    <h6 class="border-bottom pb-2 mb-3">
                                        <i class="bi bi-shop me-1"></i> @storeGroup.StoreName
                                    </h6>
                                    
                                    <!-- Items from this store -->
                                    <div class="mb-3">
                                        @foreach (var item in storeGroup.Items)
                                        {
                                            <div class="d-flex justify-content-between small text-muted mb-1">
                                                <span>@item.ProductTitle Ã— @item.Quantity</span>
                                                <span>@((item.ProductPrice * item.Quantity).ToString("C"))</span>
                                            </div>
                                        }
                                        <div class="d-flex justify-content-between small fw-bold">
                                            <span>Store Subtotal:</span>
                                            <span>@storeGroup.Subtotal.ToString("C")</span>
                                        </div>
                                    </div>

                                    <!-- Shipping options for this store -->
                                    @if (Model.ShippingMethodsByStore.TryGetValue(storeGroup.StoreId, out var methods))
                                    {
                                        @foreach (var method in methods)
                                        {
                                            var isSelected = Model.SelectedShippingMethods.TryGetValue(storeGroup.StoreId, out var selectedId) && selectedId == method.Id;
                                            <div class="form-check border rounded p-3 mb-2 @(isSelected ? "border-primary bg-light" : "")">
                                                <input class="form-check-input" type="radio"
                                                       name="SelectedShippingMethods[@storeGroup.StoreId]"
                                                       id="shipping-@storeGroup.StoreId-@method.Id"
                                                       value="@method.Id"
                                                       checked="@isSelected"
                                                       onchange="updateShippingCost()">
                                                <label class="form-check-label w-100" for="shipping-@storeGroup.StoreId-@method.Id">
                                                    <div class="d-flex justify-content-between">
                                                        <div>
                                                            <strong>@method.Name</strong>
                                                            @if (method.IsDefault)
                                                            {
                                                                <span class="badge bg-secondary ms-2">Recommended</span>
                                                            }
                                                            <br>
                                                            <small class="text-muted">@method.Description</small>
                                                            <br>
                                                            <small class="text-muted">
                                                                <i class="bi bi-clock me-1"></i>@method.EstimatedDelivery
                                                            </small>
                                                        </div>
                                                        <div class="text-end">
                                                            @if (method.Cost == 0)
                                                            {
                                                                <span class="text-success fw-bold">Free</span>
                                                            }
                                                            else
                                                            {
                                                                <span class="fw-bold">@method.Cost.ToString("C")</span>
                                                            }
                                                        </div>
                                                    </div>
                                                </label>
                                            </div>
                                        }
                                    }
                                </div>
                            }
                        </div>
                        <div class="card-footer">
                            <div class="d-flex justify-content-between">
                                <a asp-page="Checkout" class="btn btn-outline-secondary">
                                    <i class="bi bi-arrow-left me-1"></i>Back to Address
                                </a>
                                <button type="submit" class="btn btn-primary">
                                    Continue to Payment<i class="bi bi-arrow-right ms-1"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Order Summary -->
            <div class="col-lg-4">
                <div class="card sticky-top" style="top: 20px;">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Order Summary</h5>
                    </div>
                    <div class="card-body">
                        @if (Model.CartResult?.ItemsByStore != null)
                        {
                            @foreach (var storeGroup in Model.CartResult.ItemsByStore)
                            {
                                <div class="mb-3">
                                    <h6 class="text-muted small">@storeGroup.StoreName</h6>
                                    @foreach (var item in storeGroup.Items)
                                    {
                                        <div class="d-flex justify-content-between mb-1">
                                            <span class="small">
                                                @item.ProductTitle
                                                <span class="text-muted">x @item.Quantity</span>
                                            </span>
                                            <span class="small">@((item.ProductPrice * item.Quantity).ToString("C"))</span>
                                        </div>
                                    }
                                </div>
                            }
                            <hr>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Items (@Model.CartResult.TotalItemCount):</span>
                                <span>@Model.CartResult.TotalPrice.ToString("C")</span>
                            </div>
                            @if (Model.CartResult.Totals != null && Model.CartResult.Totals.DiscountAmount > 0)
                            {
                                <div class="d-flex justify-content-between mb-2 text-success">
                                    <span>
                                        <i class="bi bi-tag-fill me-1"></i>Discount
                                        @if (!string.IsNullOrEmpty(Model.CartResult.Totals.AppliedPromoCode))
                                        {
                                            <span class="small">(@Model.CartResult.Totals.AppliedPromoCode)</span>
                                        }
                                    </span>
                                    <span>-@Model.CartResult.Totals.DiscountAmount.ToString("C")</span>
                                </div>
                            }
                            <div class="d-flex justify-content-between mb-2">
                                <span>Shipping:</span>
                                <span id="totalShipping">Calculating...</span>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between">
                                <strong>Total:</strong>
                                <strong class="text-primary fs-5" id="grandTotal">--</strong>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        // Shipping costs data - uses numeric values only (store GUIDs, method IDs, costs)
        // Data is serialized from server-controlled values, not user input
        var shippingData = @Json.Serialize(
            Model.ShippingMethodsByStore.ToDictionary(
                kvp => kvp.Key.ToString(),
                kvp => kvp.Value.ToDictionary(m => m.Id, m => m.Cost)
            )
        );
        var itemsTotal = @(Model.CartResult?.TotalPrice ?? 0);
        var discountAmount = @(Model.CartResult?.Totals?.DiscountAmount ?? 0);

        function updateShippingCost() {
            var totalShipping = 0;
            
            for (var storeId in shippingData) {
                var selected = document.querySelector('input[name="SelectedShippingMethods[' + storeId + ']"]:checked');
                if (selected) {
                    var costs = shippingData[storeId];
                    totalShipping += costs[selected.value] || 0;
                }
            }
            
            var shippingDisplay = totalShipping === 0 ? 'Free' : '$' + totalShipping.toFixed(2);
            document.getElementById('totalShipping').textContent = shippingDisplay;
            
            var grandTotal = itemsTotal - discountAmount + totalShipping;
            if (grandTotal < 0) grandTotal = 0;
            document.getElementById('grandTotal').textContent = '$' + grandTotal.toFixed(2);
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateShippingCost();
        });
    </script>
}
