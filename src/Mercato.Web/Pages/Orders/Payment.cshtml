@page
@model Mercato.Web.Pages.Orders.PaymentModel
@{
    ViewData["Title"] = "Checkout - Payment";
}

<div class="container py-4">
    <h1 class="mb-4">Checkout</h1>

    <!-- Progress Steps -->
    <div class="mb-4">
        <div class="d-flex justify-content-between">
            <div class="text-center">
                <span class="badge bg-success rounded-pill p-2"><i class="bi bi-check"></i></span>
                <div class="small mt-1 text-success">Address</div>
            </div>
            <div class="text-center">
                <span class="badge bg-success rounded-pill p-2"><i class="bi bi-check"></i></span>
                <div class="small mt-1 text-success">Shipping</div>
            </div>
            <div class="text-center">
                <span class="badge bg-primary rounded-pill p-2">3</span>
                <div class="small mt-1 fw-bold">Payment</div>
            </div>
            <div class="text-center">
                <span class="badge bg-secondary rounded-pill p-2">4</span>
                <div class="small mt-1 text-muted">Confirmation</div>
            </div>
        </div>
    </div>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["Success"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert-danger">@Model.ErrorMessage</div>
    }

    <!-- Stock Validation Issues -->
    @if (Model.StockIssues.Count > 0)
    {
        <div class="alert alert-danger">
            <h5 class="alert-heading"><i class="bi bi-exclamation-triangle-fill me-2"></i>Stock Availability Issues</h5>
            <p>The following items in your cart have stock availability issues:</p>
            <ul class="mb-2">
                @foreach (var issue in Model.StockIssues)
                {
                    <li>@issue.Message</li>
                }
            </ul>
            <hr>
            <p class="mb-0">Please <a asp-page="/Cart/Index" class="alert-link">update your cart</a> to adjust quantities or remove unavailable items before proceeding.</p>
        </div>
    }

    <!-- Price Change Issues -->
    @if (Model.PriceChanges.Count > 0)
    {
        <div class="alert alert-warning">
            <h5 class="alert-heading"><i class="bi bi-info-circle-fill me-2"></i>Price Changes Detected</h5>
            <p>Some product prices have changed since you added them to your cart:</p>
            <ul class="mb-2">
                @foreach (var change in Model.PriceChanges)
                {
                    <li>
                        @change.ProductTitle:
                        <span class="text-decoration-line-through">@change.OriginalPrice.ToString("C")</span>
                        <i class="bi @(change.PriceIncreased ? "bi-arrow-up text-danger" : "bi-arrow-down text-success")"></i>
                        <strong>@change.CurrentPrice.ToString("C")</strong>
                    </li>
                }
            </ul>
            <hr>
            <div class="d-flex gap-2">
                <form method="post" asp-page-handler="AcceptPriceChanges">
                    <button type="submit" class="btn btn-warning">
                        <i class="bi bi-check-circle me-1"></i>Accept New Prices
                    </button>
                </form>
                <a asp-page="/Cart/Index" class="btn btn-outline-secondary">Review Cart</a>
            </div>
        </div>
    }

    <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

    @if (Model.IsCartEmpty)
    {
        <div class="alert alert-warning">
            Your cart is empty. <a asp-page="/Product/Index">Continue shopping</a>.
        </div>
    }
    else
    {
        <div class="row">
            <!-- Payment Method Selection -->
            <div class="col-lg-8">
                <form method="post">
                    <!-- Delivery Address Summary -->
                    @if (Model.DeliveryAddress != null)
                    {
                        <div class="card mb-4">
                            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="bi bi-geo-alt me-2"></i>Delivery Address
                                </h5>
                                <a asp-page="Checkout" class="btn btn-sm btn-outline-secondary">Change</a>
                            </div>
                            <div class="card-body">
                                <strong>@Model.DeliveryAddress.FullName</strong><br>
                                @Model.DeliveryAddress.FormattedAddress
                                @if (!string.IsNullOrEmpty(Model.DeliveryAddress.PhoneNumber))
                                {
                                    <br><span class="text-muted small"><i class="bi bi-telephone me-1"></i>@Model.DeliveryAddress.PhoneNumber</span>
                                }
                            </div>
                        </div>
                    }

                    <!-- Shipping Summary -->
                    @if (Model.ShippingData != null)
                    {
                        <div class="card mb-4">
                            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="bi bi-truck me-2"></i>Shipping
                                </h5>
                                <a asp-page="Shipping" class="btn btn-sm btn-outline-secondary">Change</a>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <span>Shipping Cost:</span>
                                    @if (Model.ShippingData.TotalShippingCost == 0)
                                    {
                                        <span class="text-success fw-bold">Free</span>
                                    }
                                    else
                                    {
                                        <span class="fw-bold">@Model.ShippingData.TotalShippingCost.ToString("C")</span>
                                    }
                                </div>
                            </div>
                        </div>
                    }

                    <!-- Payment Methods -->
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">
                                <i class="bi bi-credit-card me-2"></i>Select Payment Method
                            </h5>
                        </div>
                        <div class="card-body">
                            @foreach (var method in Model.PaymentMethods.OrderBy(m => m.SortOrder))
                            {
                                var isSelected = Model.SelectedPaymentMethodId == method.Id;
                                <div class="form-check border rounded p-3 mb-2 @(isSelected ? "border-primary bg-light" : "")">
                                    <input class="form-check-input" type="radio"
                                           name="SelectedPaymentMethodId"
                                           id="payment-@method.Id"
                                           value="@method.Id"
                                           checked="@isSelected">
                                    <label class="form-check-label w-100" for="payment-@method.Id">
                                        <div class="d-flex align-items-center">
                                            <i class="bi @method.IconClass fs-4 me-3"></i>
                                            <div>
                                                <strong>@method.Name</strong>
                                                @if (method.IsDefault)
                                                {
                                                    <span class="badge bg-secondary ms-2">Recommended</span>
                                                }
                                                <br>
                                                <small class="text-muted">@method.Description</small>
                                            </div>
                                        </div>
                                    </label>
                                </div>
                            }

                            <div class="alert alert-info mt-3 mb-0">
                                <i class="bi bi-shield-check me-2"></i>
                                <small>Your payment information is secure. This is a simulated payment for demonstration purposes.</small>
                            </div>
                        </div>
                        <div class="card-footer">
                            <div class="d-flex justify-content-between">
                                <a asp-page="Shipping" class="btn btn-outline-secondary">
                                    <i class="bi bi-arrow-left me-1"></i>Back to Shipping
                                </a>
                                @if (Model.HasValidationIssues)
                                {
                                    <button type="submit" class="btn btn-success btn-lg" disabled>
                                        <i class="bi bi-lock me-1"></i>Pay @Model.TotalAmount.ToString("C")
                                    </button>
                                }
                                else
                                {
                                    <button type="submit" class="btn btn-success btn-lg">
                                        <i class="bi bi-lock me-1"></i>Pay @Model.TotalAmount.ToString("C")
                                    </button>
                                }
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Order Summary -->
            <div class="col-lg-4">
                <div class="card sticky-top" style="top: 20px;">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Order Summary</h5>
                    </div>
                    <div class="card-body">
                        @if (Model.CartResult?.ItemsByStore != null)
                        {
                            @foreach (var storeGroup in Model.CartResult.ItemsByStore)
                            {
                                <div class="mb-3">
                                    <h6 class="text-muted small">@storeGroup.StoreName</h6>
                                    @foreach (var item in storeGroup.Items)
                                    {
                                        <div class="d-flex justify-content-between mb-1">
                                            <span class="small">
                                                @item.ProductTitle
                                                <span class="text-muted">x @item.Quantity</span>
                                            </span>
                                            <span class="small">@((item.ProductPrice * item.Quantity).ToString("C"))</span>
                                        </div>
                                    }
                                </div>
                            }
                            <hr>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Items (@Model.CartResult.TotalItemCount):</span>
                                <span>@Model.CartResult.TotalPrice.ToString("C")</span>
                            </div>
                            @if (Model.CartResult.Totals != null && Model.CartResult.Totals.DiscountAmount > 0)
                            {
                                <div class="d-flex justify-content-between mb-2 text-success">
                                    <span>
                                        <i class="bi bi-tag-fill me-1"></i>Discount
                                        @if (!string.IsNullOrEmpty(Model.CartResult.Totals.AppliedPromoCode))
                                        {
                                            <span class="small">(@Model.CartResult.Totals.AppliedPromoCode)</span>
                                        }
                                    </span>
                                    <span>-@Model.CartResult.Totals.DiscountAmount.ToString("C")</span>
                                </div>
                            }
                            <div class="d-flex justify-content-between mb-2">
                                <span>Shipping:</span>
                                @if ((Model.ShippingData?.TotalShippingCost ?? 0) == 0)
                                {
                                    <span class="text-success">Free</span>
                                }
                                else
                                {
                                    <span>@Model.ShippingData!.TotalShippingCost.ToString("C")</span>
                                }
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between">
                                <strong>Total:</strong>
                                <strong class="text-primary fs-5">@Model.TotalAmount.ToString("C")</strong>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}
